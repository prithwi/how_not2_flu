<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>How not2 flu by prithwi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    
    <!-- Inline Math using Mathjax -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          processEscapes: true
        }
      });
    </script>
    <script type="text/javascript"
      src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">How not2 flu</h1>
      <h2 class="project-tagline">Accompanying material for &quot;How not to Forecast the Flu&quot; paper.</h2>
      <!--
      <a href="https://github.com/prithwi/how_not2_flu" class="btn">View on GitHub</a>
      <a href="https://github.com/prithwi/how_not2_flu/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/prithwi/how_not2_flu/tarball/master" class="btn">Download .tar.gz</a>
      -->
    </section>

    <section class="main-content">
      <p><strong>Table of contents</strong></p>

<ol>
<li><a href="#surveillance-instability">Surveillance Instability</a></li>
<li><a href="#between-surveillance-deviations">Between Surveillance Deviations</a></li>
<li><a href="#strain-deviations">Within Surveillance Deviations</a></li>
<li><a href="#surveillance-drop-off">Drop off of surveillance</a></li>
<li><a href="#christmass-effect">Christmas Effect</a></li>
<li><a href="#data">Data and Figures</a></li>
</ol>

<hr>

<h1>
<a id="surveillance-instability" class="anchor" href="#surveillance-instability" aria-hidden="true"><span class="octicon octicon-link"></span></a>Surveillance Instability</h1>

<p>Surveillance data is generally unstable. Usually it takes a number of updates
from the agency before the surveillance data gets stabilized.  This
instability can vary from one country to another (within a single network) as
well as between networks. Here we analyze the instability of two different kinds
of surveillance networks:</p>

<ol>
<li>
<a href="#paho-Instability">PAHO</a>: FluNet network for ILI (a lab based system)</li>
<li>
<a href="#cdc-Instability">CDC</a>: ILINet network for ILI (an outpatient reporting system)</li>
</ol>

<p>As can be seen both networks show surveillance instability.</p>

<h2>
<a id="paho-instability" class="anchor" href="#paho-instability" aria-hidden="true"><span class="octicon octicon-link"></span></a>PAHO-Instability</h2>

<p>PAHO provides lab based surveillance feeds. We show the phenomenon of
<code>surveillance drop-off</code> on this network. PAHO updates for several Latin
American countries were collected daily from <code>2012-10</code> to <code>2013-10</code>.  ILI
estimates are generally updated at irregular intervals. We assumed the estimate
for a particular country for an epi week as available from the last update as
the true value and calculated percentage relative error as:</p>

<p>$\text{Error} = \frac{\text{data} - \text{last_update}}{\text{last_update}}$</p>

<p>The snapshot of the daily downloads can be found in <a href="./data/PAHO_2013-10-10.xlsx">PAHO
updates</a>. We can show the relative error as 
a function of update as given below:
<img src="./figures/ili_updates.png" alt="PAHO Instability"></p>

<p>As can be seen in the figure countries fall nicely in two groups as slowly
stabilizing countries  (such as <code>Colombia</code> and <code>Peru</code>) and quickly stabilizing
countries (such as <code>Argentina</code> and <code>El Salvador</code>).</p>

<h2>
<a id="cdc-instability" class="anchor" href="#cdc-instability" aria-hidden="true"><span class="octicon octicon-link"></span></a>CDC Instability</h2>

<p>CDC historical updates for national regions can be accessed from 
<a href="http://www.cdc.gov/flu/weekly/weeklyarchives2013-2014/data/senAllregt09.htm">cdc archives</a>
(click on the link for an example). A snapshot of the dataset can be 
found in <a href="./data/cdc-historical-2010-2015.csv">CDC historical archive snapshot</a></p>

<h3>
<a id="animated-cdc-updates" class="anchor" href="#animated-cdc-updates" aria-hidden="true"><span class="octicon octicon-link"></span></a>Animated CDC Updates</h3>

<p>An animation of how the CDC updates happens for various epi weeks is shown
below. We animate the updates for 2013-2014 season for various reporting week
here:
<img src="./figures/animated_cdc.gif" alt="Animated CDC Updates"></p>

<h3>
<a id="cdc-instability-horizon" class="anchor" href="#cdc-instability-horizon" aria-hidden="true"><span class="octicon octicon-link"></span></a>CDC Instability Horizon</h3>

<p>Similar to PAHO, we can plot the relative error of updates as a scatter plot as 
shown below. We also plot the mean relative error in this figure.
<img src="./figures/cdc_instability.png" alt="CDC instability stats"></p>

<p>As can be seen, similar to PAHO a number of updates is required before the 
value stabilizes. However, CDC data for USA is found to be <code>fast stabilizing</code>. </p>

<hr>

<h1>
<a id="surveillance-drop-off" class="anchor" href="#surveillance-drop-off" aria-hidden="true"><span class="octicon octicon-link"></span></a>Surveillance Drop-off</h1>

<p>In our opinion piece we posited that, Post-peak the surveillance efforts drops. 
We elucidate this by plotting the
scatter plot of the CDC ILINet reported number of providers as a function of
season week. As the scatter plot shows, the number of providers decreases
sharply at around season week $33$. We identified this point by finding the
inflection point of the averaged and smoothened CDC ILINet number of providers.
The inflection point is also found via smoothened version to account for
sporadic variations. The code snippet for finding the inflection point is given
below. The data archive can be found in <a href="./data/cdc-combined-national-2015-05-25.csv">cdc real time
data snapshot</a></p>

<div class="highlight highlight-source-python"><pre>selected_cdc <span class="pl-k">=</span> cdc_data.query(<span class="pl-s"><span class="pl-pds">'</span>season in [2010, 2011, 2012, 2013, 2014]<span class="pl-pds">'</span></span>)

<span class="pl-c"># Smoothing data</span>
span_size <span class="pl-k">=</span> <span class="pl-c1">4</span>
avg_providers <span class="pl-k">=</span> selected_cdc.groupby(<span class="pl-s"><span class="pl-pds">'</span>season_week<span class="pl-pds">'</span></span>).agg({<span class="pl-s"><span class="pl-pds">'</span>NUM. OF PROVIDERS<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>mean<span class="pl-pds">'</span></span>})
smooth_providers <span class="pl-k">=</span> pd.ewma(avg_providers, <span class="pl-smi">span</span><span class="pl-k">=</span>span_size)

<span class="pl-c"># Calculating gradients on smoothened data</span>
provider_summary <span class="pl-k">=</span> pd.DataFrame(<span class="pl-smi">index</span><span class="pl-k">=</span>smooth_providers.index)
provider_summary[<span class="pl-s"><span class="pl-pds">'</span>average<span class="pl-pds">'</span></span>] <span class="pl-k">=</span> smooth_providers
provider_summary[<span class="pl-s"><span class="pl-pds">'</span>grad2<span class="pl-pds">'</span></span>] <span class="pl-k">=</span> np.gradient(np.gradient(smooth_providers.values.flatten()))
provider_summary[<span class="pl-s"><span class="pl-pds">'</span>grad2sign<span class="pl-pds">'</span></span>] <span class="pl-k">=</span> np.sign(provider_summary[<span class="pl-s"><span class="pl-pds">'</span>grad2<span class="pl-pds">'</span></span>])

<span class="pl-c"># Calculating smoothened inflection point</span>
provider_summary[<span class="pl-s"><span class="pl-pds">'</span>inflect<span class="pl-pds">'</span></span>] <span class="pl-k">=</span>  pd.rolling_sum(provider_summary[<span class="pl-s"><span class="pl-pds">'</span>grad2sign<span class="pl-pds">'</span></span>], 
                                              <span class="pl-smi">window</span><span class="pl-k">=</span>span_size).shift(<span class="pl-k">-</span>span_size <span class="pl-k">+</span> <span class="pl-c1">1</span>)

<span class="pl-c"># Inflection point = first point where you get a sum of span_size</span>
inflection_point <span class="pl-k">=</span> provider_summary[provider_summary[<span class="pl-s"><span class="pl-pds">'</span>inflect<span class="pl-pds">'</span></span>] <span class="pl-k">==</span> span_size].index[<span class="pl-c1">0</span>]</pre></div>

<p>The resultant scatter plot is shown below:</p>

<p><img src="./figures/ili_surveillance_drop.png" alt="CDC Scatter plot"></p>

<hr>

<h1>
<a id="between-surveillance-deviations" class="anchor" href="#between-surveillance-deviations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Between Surveillance Deviations</h1>

<p>Often times, there are deviations in estimated ILI incidence for two different
networks for the same region. We illustrate this for CDC by comparing <code>ILINet</code> 
against <code>WHO NREVSS</code>. We show this comparison for the national region. However, 
similar analysis can be done for other regions as well. We compare the
estimates from two different networks below:
The data archive can be found in <a href="./data/cdc-combined-national-2015-05-25.csv">cdc
real time data snapshot</a></p>

<p><img src="./figures/ilinet_vs_nrevss.png" alt="ILINet vs WHO NREVSS"></p>

<hr>

<h1>
<a id="strain-deviations" class="anchor" href="#strain-deviations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Strain Deviations</h1>

<p>Similar to surveillance deviations, there could be deviations in ILI patterns
for different strains that is broadly encompassed by the term ILI. </p>

<p>Strain estimates can be obtained from <code>WHO NREVSS</code> (which is a lab based
surveillance system). We scale the strain estimates to ILINet reported levels
and compare the incidence of total ILI vs Flu A and Flu B. </p>

<p>The code snippet for the scale conversions is given below:</p>

<div class="highlight highlight-source-python"><pre><span class="pl-c"># **************************************************************</span>
<span class="pl-c">#                   MANIPULATORS</span>
<span class="pl-c"># **************************************************************</span>
<span class="pl-c"># Get ratios</span>
<span class="pl-k">def</span> <span class="pl-en">get_ratios</span>(<span class="pl-smi">X</span>, <span class="pl-smi">col1</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>FLUA<span class="pl-pds">'</span></span>, <span class="pl-smi">col2</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>B<span class="pl-pds">'</span></span>, <span class="pl-smi">epsilon</span><span class="pl-k">=</span><span class="pl-c1">1</span>, <span class="pl-smi">suffix</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>_per<span class="pl-pds">'</span></span>):
    <span class="pl-s"><span class="pl-pds">"""</span> lambda funtion to get ratios of col1 and col2 as percentage.</span>
<span class="pl-s">    <span class="pl-pds">"""</span></span>
    denom <span class="pl-k">=</span> X[col1] <span class="pl-k">+</span> X[col2] <span class="pl-k">+</span> epsilon
    num1 <span class="pl-k">=</span> ((X[col1] <span class="pl-k">+</span> epsilon)<span class="pl-k">/</span> denom).fillna(<span class="pl-c1">0</span>)
    num2 <span class="pl-k">=</span> ((X[col2] <span class="pl-k">+</span> epsilon)<span class="pl-k">/</span> denom).fillna(<span class="pl-c1">0</span>)
    <span class="pl-k">return</span> pd.DataFrame({col1<span class="pl-k">+</span>suffix: num1,
                         col2<span class="pl-k">+</span>suffix: num2})


<span class="pl-c"># Get ILINET values</span>
<span class="pl-k">def</span> <span class="pl-en">get_values</span>(<span class="pl-smi">X</span>):
    <span class="pl-s"><span class="pl-pds">"""</span> lambda funtion to get ILINET VALUES</span>
<span class="pl-s">    <span class="pl-pds">"""</span></span>

    <span class="pl-k">return</span> (np.round(X[<span class="pl-s"><span class="pl-pds">'</span>FLUA_per<span class="pl-pds">'</span></span>] <span class="pl-k">*</span> X[<span class="pl-s"><span class="pl-pds">'</span>ILITOTAL<span class="pl-pds">'</span></span>]),
            np.round(X[<span class="pl-s"><span class="pl-pds">'</span>B_per<span class="pl-pds">'</span></span>] <span class="pl-k">*</span> X[<span class="pl-s"><span class="pl-pds">'</span>ILITOTAL<span class="pl-pds">'</span></span>]))


<span class="pl-c"># ***************************************************************</span>
<span class="pl-c">#                   Scaling of WHO data to ILINet Scale</span>
<span class="pl-c"># ***************************************************************</span>
combined_who_columns <span class="pl-k">=</span> [<span class="pl-s"><span class="pl-k">u</span><span class="pl-pds">'</span>PERCENT POSITIVE<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-k">u</span><span class="pl-pds">'</span>B<span class="pl-pds">'</span></span>,
                        <span class="pl-s"><span class="pl-k">u</span><span class="pl-pds">'</span>FLUA<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-k">u</span><span class="pl-pds">'</span>FLUA_per<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-k">u</span><span class="pl-pds">'</span>B_per<span class="pl-pds">'</span></span>]
<span class="pl-c"># calculating ratios of strains</span>
cdc_who[[<span class="pl-s"><span class="pl-pds">'</span>FLUA_per<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>B_per<span class="pl-pds">'</span></span>]] <span class="pl-k">=</span> (get_ratios(cdc_who, <span class="pl-smi">epsilon</span><span class="pl-k">=</span><span class="pl-c1">0</span>)
                                  [[<span class="pl-s"><span class="pl-pds">'</span>FLUA_per<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>B_per<span class="pl-pds">'</span></span>]])
<span class="pl-c"># merging frames</span>
combined_df <span class="pl-k">=</span> (cdc_net.join(cdc_who[combined_who_columns]))[<span class="pl-s"><span class="pl-pds">'</span>2004<span class="pl-pds">'</span></span>:]
<span class="pl-c"># Scaling ILINet according to strain ratios</span>
combined_df[<span class="pl-s"><span class="pl-pds">'</span>ILI_FLUA<span class="pl-pds">'</span></span>], combined_df[<span class="pl-s"><span class="pl-pds">'</span>ILI_FLUB<span class="pl-pds">'</span></span>] <span class="pl-k">=</span> <span class="pl-c1">zip</span>(<span class="pl-k">*</span>combined_df.apply(get_values, <span class="pl-smi">axis</span><span class="pl-k">=</span><span class="pl-c1">1</span>)) </pre></div>

<p>The raw <a href="./data/cdc-ILINet-national-2015-05-25.csv">ILINet data</a> and 
<a href="./data/cdc-WHO_NREVSS-national-2015-05-25.csv">NREVSS data</a> is merged 
together to <a href="./data/cdc-combined-national-2015-05-25.csv">Combined data</a> 
for public perusal.</p>

<p>This can be show pictorially as given below which shows a phase deviation
between Flu B and ILI
<img src="./figures/ilinet_subtyped.png" alt="CDC ILI strain offsets"></p>

<hr>

<h1>
<a id="christmas-effect" class="anchor" href="#christmas-effect" aria-hidden="true"><span class="octicon octicon-link"></span></a>Christmas Effect</h1>

<p>Surveillance measures can often suffer from variations such as holiday periods.
During holidays, such as Christmas in USA, people may chose to visit hospitals for only
essential visits (example: people may not visit for elective surgeries). 
As a result, although the total number of patients may decrease, the number of 
ILI related visits may remain the same. This contributes to an inflated
measure of <code>Percent Weighted ILI</code> which is used by CDC to determine the severity
of a flu season and lead to a double peaked season.</p>

<p>The code snippet for processing the data to verify the <code>Christmass Effect</code> is
given below:</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">normalize</span>(<span class="pl-smi">df</span>):
    <span class="pl-k">return</span> (df <span class="pl-k">-</span> df.mean(<span class="pl-smi">axis</span><span class="pl-k">=</span><span class="pl-c1">0</span>)) <span class="pl-k">/</span> df.std(<span class="pl-smi">axis</span><span class="pl-k">=</span><span class="pl-c1">0</span>)

used_cdc <span class="pl-k">=</span> cdc_data.query(<span class="pl-s"><span class="pl-pds">'</span>2004 &lt; season &lt; 2015<span class="pl-pds">'</span></span>)

<span class="pl-c"># Normalizing ILI and TOTAL to plot on same scale</span>
cdc[[<span class="pl-s"><span class="pl-pds">'</span>NormalizedILI<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>NormalizedTOTAL<span class="pl-pds">'</span></span>]] <span class="pl-k">=</span> (cdc[[<span class="pl-s"><span class="pl-pds">'</span>ILITOTAL<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>TOTAL PATIENTS<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>season<span class="pl-pds">'</span></span>]].groupby(<span class="pl-s"><span class="pl-pds">'</span>season<span class="pl-pds">'</span></span>)
                                             .apply(normalize)[[<span class="pl-s"><span class="pl-pds">'</span>ILITOTAL<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>TOTAL PATIENTS<span class="pl-pds">'</span></span>]])

metrics <span class="pl-k">=</span> [<span class="pl-s"><span class="pl-pds">'</span>NormalizedTOTAL<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>NormalizedILI<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span><span class="pl-c1">% W</span>EIGHTED ILI<span class="pl-pds">'</span></span>]

<span class="pl-c"># Calculating means for each week</span>
meanDF <span class="pl-k">=</span> used_cdc.groupby(<span class="pl-s"><span class="pl-pds">'</span>WEEK<span class="pl-pds">'</span></span>).mean()[metrics]


<span class="pl-c"># Reindexing the plotting dataframe to plot from 40-39 weeks</span>
x<span class="pl-k">=</span>np.r_[np.arange(<span class="pl-c1">40</span>, <span class="pl-c1">53</span>), np.arange(<span class="pl-c1">1</span>,<span class="pl-c1">40</span>)]
other_x <span class="pl-k">=</span> np.arange(<span class="pl-c1">len</span>(x))
index_map <span class="pl-k">=</span> <span class="pl-c1">dict</span>(<span class="pl-c1">zip</span>(x, other_x))
plot_meanDF <span class="pl-k">=</span> meanDF.ix[x, :].reset_index()</pre></div>

<p><code>Christmass effect</code> is highlighted below which shows that a dip in normalized
total visits coupled with a steady ILI related visit contributes to an inflated
percent ILI, historically around week 52 for ILINet in USA.</p>

<p><img src="./figures/christmass_effect.png" alt="Christmas effect"></p>

<hr>

<h1>
<a id="list-of-data-snapshots" class="anchor" href="#list-of-data-snapshots" aria-hidden="true"><span class="octicon octicon-link"></span></a>List of Data Snapshots</h1>

<ol>
<li><a href="./data/cdc-historical-2010-2015.csv">CDC Historical Archives</a></li>
<li><a href="./data/cdc-ILINet-national-2015-05-25.csv">CDC ILINet</a></li>
<li><a href="./data/cdc-WHO_NREVSS-national-2015-05-25.csv">CDC WHONREVSS</a></li>
<li><a href="./data/PAHO_2013-10-10.xlsx">PAHO</a></li>
<li><p><a href="./data/cdc-combined-national-2015-05-25.csv">CDC Combined Surveillance
File</a></p></li>
<li>
<p>Performance Measures:</p>

<ol>
<li><a href="./data/singleSource.csv">Single Source accuracy</a></li>
<li><a href="./data/MultipleSource.csv">Multiple Source accuracy</a></li>
</ol>
</li>
</ol>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/prithwi/how_not2_flu">How not2 flu</a> is maintained by <a href="https://github.com/prithwi">prithwi</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
