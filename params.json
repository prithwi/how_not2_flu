{"name":"How not2 flu","tagline":"Accompanying material for \"how not to forecast flu\" paper.","body":"# How Not 2 Flu\r\nAccompanying material for \"how not to forecast flu\" paper.\r\n\r\n\r\n**Table of contents**\r\n\r\n1. [Surveillance Instability](#surveillance-instability)\r\n1. [Between Surveillance Deviations](#between-surveillance-deviations)\r\n2. [Within Surveiillance Deviations](#strain-deviations)\r\n4. [Drop off of surveillance](#surveillance-drop-off)\r\n5. [Christmass Effect](#christmass-effect)\r\n6. [Data and Figures](#data)\r\n\r\n- - -\r\n\r\n# Surveillance Instability\r\n\r\nSurveillance data is genrally unstable. Usually it takes a number of updates\r\nfrom the agency before the surveillance data gets stabilizied.  This\r\ninstability can vary from one country to another (within a single network) as\r\nwell as between networks. Here we analyze the instability of two different kinds\r\nof surveillance networks:\r\n\r\n1. [PAHO](#paho-Instability): FluNet network for ILI (a lab based system)\r\n2. [CDC](#cdc-Instability): ILINet network for ILI (an outpatient reporting system)\r\n\r\nAs can be seen both networks show surveillance instability.\r\n\r\n## PAHO-Instability\r\n\r\n\r\nPAHO provides lab based surveillance feeds. We show the phenomenon of\r\n`surveillance drop-off` on this network. PAHO updates for several Latin\r\nAmerican countries were collected daily from `2012-10` to `2013-10`.  ILI\r\nestimates are generally updated at irregular intervals. We assumed the estimate\r\nfor a particular country for an epi week as avialable from the last update as\r\nthe true value and calculated percentage relative error as:\r\n\r\n$\\text{Error} = \\frac{\\text{data} - \\text{last_update}}{\\text{last_update}}$\r\n\r\nThe snapshot of the daily downloads can be found in [PAHO\r\nupdates](./data/PAHO_2013-10-10.xlsx). We can show the relative error as \r\na function of update as given below:\r\n![PAHO Instabiity](./figures/ili_updates.png)\r\n\r\nAs can be seen in the figure countries fall nicely in two groups as slowly\r\nstabilizing countries  (such as `Colombia` and `Peru`) and quickly stabilizing\r\ncountries (such as `Argentina` and `El Salvador`).\r\n\r\n## CDC Instability\r\n\r\nCDC historical updates for national regions can be accessed from \r\n[cdc archives](http://www.cdc.gov/flu/weekly/weeklyarchives2013-2014/data/senAllregt09.htm)\r\n(click on the link for an example). A snapshot of the dataset can be \r\nfound in [CDC historical archive snapshot](./data/cdc-historical-2010-2015.csv)\r\n\r\n### Animated CDC Updates\r\n\r\nAn animation of how the CDC updates happens for varios epi weeks is shown\r\nbelow. We animate the updates for 2013-2014 season for various reporting week\r\nhere:\r\n![Animated CDC Updates](./figures/animated_cdc.gif)\r\n\r\n### CDC Instability Horizon\r\nSimilar to PAHO, we can plot the relative error of updates as a scatter plot as \r\nshown below. We also plot the mean relative error in this figure.\r\n![CDC instability stats](./figures/cdc_instability.png)\r\n\r\nAs can be seen, similar to PAHO a number of updates is required before the \r\nvalue stabilizies. However, CDC data for USA is found to be `fast stabilizing`. \r\n\r\n\r\n- - -\r\n\r\n\r\n# Surveillance Drop-off\r\n\r\nIn our opinion piece we posited that, Post-peak the surveillance efforts drops. \r\nWe elucidate this by plotting the\r\nscatter plot of the CDC ILINet reported number of providers as a function of\r\nseason week. As the scatter plot shows, the number of providers decreases\r\nsharply at around season week $33$. We identified this point by finding the\r\ninflection point of the averaged and smoothened CDC ILINet number of providers.\r\nThe inflection point is also found via smotthened version to account for\r\nsporadic variations. the code snippet for finding the inflection point is given\r\nbelow. The data archive can be found in [cdc real time\r\ndata snapshot](./data/cdc-combined-national-2015-05-25.csv)\r\n\r\n\r\n```python\r\nselected_cdc = cdc_data.query('season in [2010, 2011, 2012, 2013, 2014]')\r\n\r\n# Smoothing data\r\nspan_size = 4\r\navg_providers = selected_cdc.groupby('season_week').agg({'NUM. OF PROVIDERS': 'mean'})\r\nsmooth_providers = pd.ewma(avg_providers, span=span_size)\r\n\r\n# Calculating gradients on smoothened data\r\nprovider_summary = pd.DataFrame(index=smooth_providers.index)\r\nprovider_summary['average'] = smooth_providers\r\nprovider_summary['grad2'] = np.gradient(np.gradient(smooth_providers.values.flatten()))\r\nprovider_summary['grad2sign'] = np.sign(provider_summary['grad2'])\r\n\r\n# Calculating smoothened inflection point\r\nprovider_summary['inflect'] =  pd.rolling_sum(provider_summary['grad2sign'], \r\n                                              window=span_size).shift(-span_size + 1)\r\n\r\n# Inflection point = first point where you get a sum of span_size\r\ninflection_point = provider_summary[provider_summary['inflect'] == span_size].index[0]\r\n```\r\n\r\nThe resultant scatter plot is shown below:\r\n\r\n![CDC Scatter plot](./figures/ili_surveillance_drop.png)\r\n\r\n- - -\r\n\r\n# Between Surveillance Deviations \r\n\r\nOften times, there are deviations in estimated ILI incidence for two different\r\nnetworks for the same region. We illustrate this for CDC by comparing `ILINet` \r\nagainst `WHO NREVSS`. We show this comparison for the national region. However, \r\nsimilar analysis can be done for other regions as well. We compare the\r\nestimates from two different networks below:\r\nThe data archive can be found in [cdc\r\nreal time data snapshot](./data/cdc-combined-national-2015-05-25.csv)\r\n\r\n![ILINet vs WHO NREVSS](./figures/ilinet_vs_nrevss.png)\r\n\r\n- - -\r\n\r\n# Strain Deviations\r\n\r\nSimilar to surveillane deviations, there could be deviations in ILI patterns\r\nfor different strains that is broadly encompassed by the term ILI. \r\n\r\nStrain estimates can be obtained from `WHO NREVSS` (which is a lab based\r\nsurveillance system). We scale the strain estimates to ILINet reported levels\r\nand compare the incidence of total ILI vs Flu A and Flu B. \r\n\r\nThe code snippet for the scale conversions is given below:\r\n\r\n```python\r\n# **************************************************************\r\n#                   MANIPULATORS\r\n# **************************************************************\r\n# Get ratios\r\ndef get_ratios(X, col1='FLUA', col2='B', epsilon=1, suffix='_per'):\r\n    \"\"\" lambda funtion to get ratios of col1 and col2 as percentage.\r\n    \"\"\"\r\n    denom = X[col1] + X[col2] + epsilon\r\n    num1 = ((X[col1] + epsilon)/ denom).fillna(0)\r\n    num2 = ((X[col2] + epsilon)/ denom).fillna(0)\r\n    return pd.DataFrame({col1+suffix: num1,\r\n                         col2+suffix: num2})\r\n\r\n\r\n# Get ILINET values\r\ndef get_values(X):\r\n    \"\"\" lambda funtion to get ILINET VALUES\r\n    \"\"\"\r\n    \r\n    return (np.round(X['FLUA_per'] * X['ILITOTAL']),\r\n            np.round(X['B_per'] * X['ILITOTAL']))\r\n\r\n\r\n# ***************************************************************\r\n#                   Scaling of WHO data to ILINet Scale\r\n# ***************************************************************\r\ncombined_who_columns = [u'PERCENT POSITIVE', u'B',\r\n                        u'FLUA', u'FLUA_per', u'B_per']\r\n# calculating ratios of strains\r\ncdc_who[['FLUA_per', 'B_per']] = (get_ratios(cdc_who, epsilon=0)\r\n                                  [['FLUA_per', 'B_per']])\r\n# merging frames\r\ncombined_df = (cdc_net.join(cdc_who[combined_who_columns]))['2004':]\r\n# Scaling ILINet according to strain ratios\r\ncombined_df['ILI_FLUA'], combined_df['ILI_FLUB'] = zip(*combined_df.apply(get_values, axis=1)) \r\n```\r\nThe raw [ILINet data](./data/cdc-ILINet-national-2015-05-25.csv) and \r\n[NREVSS data](./data/cdc-WHO_NREVSS-national-2015-05-25.csv) is merged \r\ntogether to [Combined data](./data/cdc-combined-national-2015-05-25.csv) \r\nfor pulbic perusal.\r\n\r\nThis can be show pictorially as given below which shows a phase deviation\r\nbetween Flu B and ILI\r\n![CDC ILI strain offsets](./figures/ilinet_subtyped.png)\r\n\r\n- - -\r\n\r\n# Christmass Effect\r\n\r\nSurveillance measures can often suffer from variations such as holiday periods.\r\nDuring holidays, such as Christmass in USA, people may chose to visit hospitals for only\r\nessential visits (example: people may not visit for elective surgeries). \r\nAs a result, although the total number of patients may decrease, the number of \r\nILI related visits may remain the same. This contributes to an inflated\r\nmeasure of `Percent Weighted ILI` which is used by CDC to determine the severity\r\nof a flu season and lead to a double peaked season.\r\n\r\nThe code snippet for processing the data to verify the `Christmass Effect` is\r\ngiven below:\r\n\r\n```python\r\ndef normalize(df):\r\n    return (df - df.mean(axis=0)) / df.std(axis=0)\r\n\r\nused_cdc = cdc_data.query('2004 < season < 2015')\r\n\r\n# Normalizing ILI and TOTAL to plot on same scale\r\ncdc[['NormalizedILI', 'NormalizedTOTAL']] = (cdc[['ILITOTAL', 'TOTAL PATIENTS', 'season']].groupby('season')\r\n                                             .apply(normalize)[['ILITOTAL', 'TOTAL PATIENTS']])\r\n\r\nmetrics = ['NormalizedTOTAL', 'NormalizedILI', '% WEIGHTED ILI']\r\n\r\n# Calculating means for each week\r\nmeanDF = used_cdc.groupby('WEEK').mean()[metrics]\r\n\r\n\r\n# Reindexing the plotting dataframe to plot from 40-39 weeks\r\nx=np.r_[np.arange(40, 53), np.arange(1,40)]\r\nother_x = np.arange(len(x))\r\nindex_map = dict(zip(x, other_x))\r\nplot_meanDF = meanDF.ix[x, :].reset_index()\r\n```\r\n\r\n`Christmass effect` is highlighted below which shows that a dip in normalized\r\ntotal visits coupled with a steady ILI related visit contributes to an inlated\r\npercent ILI, historically around week 52 for ILINet in USA.\r\n\r\n![png](./figures/christmass_effect.png)\r\n\r\n- - -\r\n\r\n# List of Data Snapshots\r\n\r\n1. [CDC Historical Archives](./data/cdc-historical-2010-2015.csv)\r\n2. [CDC ILINet](./data/cdc-ILINet-national-2015-05-25.csv)\r\n3. [CDC WHONREVSS](./data/cdc-WHO_NREVSS-national-2015-05-25.csv)\r\n4. [PAHO](./data/PAHO_2013-10-10.xlsx)\r\n5. [CDC Combined Surveillance\r\n   File](./data/cdc-combined-national-2015-05-25.csv)\r\n\r\n6. Performance Measures:\r\n\r\n    1. [Single Source accuracy](./data/singleSource.csv)\r\n    2. [Multiple Source accuracy](./data/MultipleSource.csv)\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}